name: Deploy Java Application

on:
  push:
    branches:
      - main  # Trigger deployment on pushing to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Set up SSH key
      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          # Decode the SSH private key stored in GitHub Secrets
          echo "$EC2_SSH_KEY" | base64 -d > ~/.ssh/newkey.pem
          chmod 600 ~/.ssh/newkey.pem  # Set proper permissions

      # Add EC2 to known hosts
      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H 44.220.156.184 >> ~/.ssh/known_hosts

      # Deploy to EC2
      - name: Deploy to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/newkey.pem ubuntu@44.220.156.184 << 'EOF'
            # Navigate to the project directory
            cd /home/ubuntu/java-login-app  # Correct path based on your tree structure
            # Pull the latest changes from the GitHub repository
            git pull origin main
            # Stop the current Docker containers
            sudo docker-compose down
            # Rebuild and start the containers
            sudo docker-compose up -d --build
          EOF
